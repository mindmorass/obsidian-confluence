name: Release Obsidian Plugin

on:
    push:
        tags:
            - "obsidian-plugin-v*"
    workflow_dispatch:
        inputs:
            version:
                description: "Version to release (e.g., 5.5.6)"
                required: true
                type: string
            skip_build:
                description: "Skip build step (use existing dist files)"
                required: false
                type: boolean
                default: false

permissions:
    contents: write

jobs:
    build-and-release:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              if: ${{ github.event_name == 'push' || !inputs.skip_build }}
              run: npm ci

            - name: Build libraries
              if: ${{ github.event_name == 'push' || !inputs.skip_build }}
              run: npm run build:libs

            - name: Build obsidian plugin
              if: ${{ github.event_name == 'push' || !inputs.skip_build }}
              working-directory: packages/obsidian
              run: npm run build

            - name: Extract version from tag or input
              id: get_version
              run: |
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                      VERSION="${{ inputs.version }}"
                  else
                      VERSION=${GITHUB_REF#refs/tags/obsidian-plugin-v}
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Building release for version: $VERSION"

            - name: Verify build artifacts
              working-directory: packages/obsidian
              run: |
                  if [ ! -f "dist/main.js" ]; then
                      echo "Error: dist/main.js not found after build"
                      exit 1
                  fi
                  if [ ! -f "manifest.json" ]; then
                      echo "Error: manifest.json not found"
                      exit 1
                  fi

                  # Verify manifest version matches version (tag or input)
                  MANIFEST_VERSION=$(jq -r '.version' manifest.json)
                  RELEASE_VERSION="${{ steps.get_version.outputs.version }}"
                  if [ "$MANIFEST_VERSION" != "$RELEASE_VERSION" ]; then
                      echo "Warning: manifest.json version ($MANIFEST_VERSION) does not match release version ($RELEASE_VERSION)"
                      echo "Continuing anyway for manual release..."
                  fi
                  echo "Build artifacts verified successfully"

            - name: Create tag for manual release
              if: ${{ github.event_name == 'workflow_dispatch' }}
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag -a "obsidian-plugin-v${{ steps.get_version.outputs.version }}" -m "Release obsidian plugin v${{ steps.get_version.outputs.version }}"
                  git push origin "obsidian-plugin-v${{ steps.get_version.outputs.version }}"

            - name: Create release archive
              working-directory: packages/obsidian
              run: |
                  mkdir -p release
                  cp dist/main.js release/
                  cp manifest.json release/
                  cd release
                  zip -r ../confluence-integration-${{ steps.get_version.outputs.version }}.zip .
                  cd ..
                  tar -czf confluence-integration-${{ steps.get_version.outputs.version }}.tar.gz -C release .

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ github.event_name == 'workflow_dispatch' && format('obsidian-plugin-v{0}', steps.get_version.outputs.version) || github.ref_name }}
                  files: |
                      packages/obsidian/dist/main.js
                      packages/obsidian/manifest.json
                      packages/obsidian/confluence-integration-${{ steps.get_version.outputs.version }}.zip
                      packages/obsidian/confluence-integration-${{ steps.get_version.outputs.version }}.tar.gz
                  generate_release_notes: true
                  draft: false
                  prerelease: false
